<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
#parse('/tcom/template.rap.vm')
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>RAP - Page Tester        </title>
        <link rel="stylesheet" href="http://10.235.160.141:8806/stat/css/rap.template.css" type="text/css" media="screen">
		<link type="text/css" rel="stylesheet" href="${staticRoot}/css/pageTester.css" />
        <script src="http://yui.yahooapis.com/3.5.1/build/yui/yui-min.js"></script>
        <script src="${staticRoot}/js/util/jsformat.js"></script>
	</head>
	<body>
	    #bodyStart
        <h2>PAGE INFO</h2>
        跟路径：<input id="txtRootPath" type="text" style="width:500px;" value="10.235.160.141:8806/mock/$!projectId"></input> 
        <h2>RESPONSE BOARD</h2>
        <div class="block" id="divResBoard">
            <div id="divResBoardJson">ready</div>
            <div id="divResBoardLog"></div>
            <div class="clear"></div>
        </div>
        <div id="divActionList">
            #foreach($action in $page.actionList)
            <h2>Action: $action.name</h2>
            <div class="tester-form">
                <form name="form$!velocityCount" class="form" method="post" path="$!action.requestUrl" onsubmit="return false;">
                    <div class="item">请求地址：/report/queryUserData</div>
                    #foreach($para in $action.requestParameterList)
                    <div class="item">
                        <input type="text" width="200px" class="field" name="$!para.identifier" />&nbsp; &nbsp;变量名:
                        <font color='red'>$!para.identifier</font>&nbsp;&nbsp;变量意义:
                        <font color='gray'>$!para.name</font>&nbsp;&nbsp;备注:
                        <font color='blue'>$!para.remark</font>
                    </div>
                    #end
                    <div class="item">
                        <input type="button" class="button" value="Run"/>
                    </div>
                </form>
            </div>
            #end
        </div>
        <div class="bottom">&nbsp;</div>
        #bodyEnd
        <script>
            YUI().use('handlebars', 'node', 'event', 'jsonp', 'jsonp-url', 'json-stringify', function (Y) {
                var source = Y.one("#resBoard-template"),
                    TResBoard = Y.Handlebars.compile(source),
                    divLog = document.getElementById("divResBoardLog"),
                    logLine = 1;
                log('tester initializing...');
                Y.timeLog = {};

                Y.all('.form').each(function(form) {
                    form.one('.button').on('click', function(e) {
                        Y.one('#divResBoardJson').setHTML('加载中，请稍后...');
                        var url = '',
                            qArr = [],
                            i = 0,
                            fields = form.all('.field'),
                            baseUrl = Y.one('#txtRootPath').get('value') + form.getAttribute('path');

                        fields.each(function(field) {
                            var name = field.get('name'),
                                value = field.get('value');
                            qArr[i++] = name + '=' + encodeURIComponent(value);
                        });

                        if (!~baseUrl.indexOf('http://')) {
                            baseUrl = "http://" + baseUrl;
                        }
                        url = baseUrl + '?' + qArr.join('&');
                        log('request starting<span style="color:#999">, url=' + url + '</span>');
                        Y.timeLog['time'] = new Date().getTime();
                        try {

                        Y.jsonp(url, {
                            on : {
                                success : testResHandler,
                                timeout : function() {
                                    log('<span style="color:red;">timeout</span>... so long time to response!');
                                },
                                failure : function(e) {
                                    window._arg = arguments;
                                    log('<span style="color:red;">error occurred!</span><span style="color:#999;">, detail:' + e.errors[0].error + '</span>');
                                }
                            },
                            timeout : 10000
                        });                        
                        } catch(e) {
                        alert(e);
                    }

                    });
                });

                function testResHandler(response) {
                    var beginTime = Y.timeLog['time'];
                    if (!beginTime) return;
                    var endTime = new Date().getTime();
                    log('request end in:<span style="color:Red;">' + (endTime - beginTime) + '</span>ms.');

                    Y.one('#divResBoardJson').setHTML(Y.JSON.stringify(response).formatJS());
                    
                }

                function log(msg) {
                    divLog.innerHTML = '<span style="color:orange;">' + (logLine++) + '</span>:&nbsp&nbsp;' + msg + "<br />" + divLog.innerHTML;
                }

                log('tester ready.');
            });
        </script>
    </body>
</html>
