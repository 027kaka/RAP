<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>WebTeam5 Spider</title>
    <style>
    </style>
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="usedData.js"></script>
</head>
<body>
    Laiwang Spider, powered by Bosn.<br />
    <br />
    <br />
    说明: 最终结果在result中...使用时要加载usedData来过滤已使用过的数据。在usedData.js中定义：var usedData = [];即可。没有则忽略。
</body>

<script type="text/javascript">
    /***********************************************************
     *                                                         *
     *           CONFIGURATIONS BEGIN                          *
     *                                                         *
     ***********************************************************/
    var ACCESS_TOKEN = '{{id}}';           // token
    var GROUP_LIMIT = 100;                 // 处理多少个扎堆
    var POST_IN_GROUP_LIMIT = 30;          // 每个扎堆拉多少次数据
    /***********************************************************
     *                                                         *
     *           CONFIGURATIONS END                            *
     *                                                         *
     ***********************************************************/

    var USER_ID = ACCESS_TOKEN.substring(ACCESS_TOKEN.indexOf('_') + 1);
    console.log("token:", ACCESS_TOKEN, ", userId:", USER_ID);
    var usedData = usedData || [];

    // obtain groups
    var groups = [];
    var curGroupIndex = 0;
    var groupsLength = 0;
    var dataPool = [];
    var result = [];
    $.ajax({
        type : "get",
        url : "http://api.laiwang.com/v1/event/favorite/list?access_token=" + ACCESS_TOKEN + "&size=100&timestamp=" + new Date().getTime(),
        success : function(o) {
            var arr = o.values;
            var n = arr.length;
            while (n--) {
                groups.push(arr[n]);
            }
            groupsLength = groups.length;
            processGroups();
        }
    });

   
    // obtain groups data
    function processGroups() {
        console.log("Start processing the ", (curGroupIndex++) + 1, " of ", groupsLength , " group...");
        processGroup(groups[groups.length - 1], function(data) {
            dataPool.push(data);
            groups.length -= 1;
            if (groups.length <= 0 || curGroupIndex > GROUP_LIMIT - 1) {
                console.log("Processed all groups!");
                processDataPool();
                return;
            } else {
                setTimeout(processGroups, 500);
            }
        });
        
    }

    function processGroup(group, cb) {
        var groupId = group.id;
        var data = [];
        var timestamp = new Date().getTime();
        processGroupSub(data, timestamp, groupId, cb, null, 0);
    }

    function processGroupSub(data, timestamp, groupId, cb, nextCursor, index) {
        console.log("Performing the ", index + 1, "th load in group...");
        var url = "http://api.laiwang.com/v1/feed/post/event/list?access_token=" + ACCESS_TOKEN + "&size=20&eventId=" + groupId + "&timestamp=" + timestamp;
        if (nextCursor) {
            url += "&cursor=" + nextCursor;
        }
        $.ajax({
            type : "get",
            url : url,
            success : function(o) {
                data.push(o.values);
                if (o.nextCursor === 0 || index >= POST_IN_GROUP_LIMIT - 1) {
                    cb(data);
                } else {
                    setTimeout(function() {
                        processGroupSub(data, timestamp, groupId, cb, o.nextCursor, index + 1);
                    }, 500 * Math.random());
                }
            }
        });
    }

    function processDataPool() {
        result = [];
        console.log("Start processing dataPool...");
        var data = dataPool;
        var n;
        var o, o2;
        var i, j, k;
        var usedMap = {};
        var resultMap = {};
        var c;
        var id;
        var pc = 0;
        var totalMap = {};
        
        console.log("process used map...");
        n = usedData.length;
        c = 0;
        while (n--) {
            usedMap[usedData[n]] = true;
            c++;
        }
        console.log(c + " items in usedData. We'll filter these duplicated ids.");

        n = data.length;
        while (n--) {
            o = data[n];
            i = o.length;
            while (i--) {
                o2 = o[i];
                j = o2.length;
                while (j--) {
                    o3 = o2[j];
                    k = o3.comments.length;
                    while (k--) {
                        id = o3.comments[k].commentor.id;
                        pc++;
                        totalMap[id] = true;
                        if (!usedMap[id]) {
                            resultMap[id] = true;
                        }
                    }
                    k = o3.emotions.length;
                    while (k--) {
                        pc++;
                        id = o3.emotions[k].user.id;
                        totalMap[id] = true;
                        if (!usedMap[id]) {
                            resultMap[id] = true;
                        }
                    }
                    id = o3.publisher.id;
                    pc++;
                    totalMap[id] = true;
                    if (!usedMap[id]) {
                        resultMap[id] = true;
                    } 
                }
            }

        }

        for (key in resultMap) {
            result.push(key);
        }
        console.log("Process complete, collected ", result.length, " userIds. Enjoy :), powered by Bosn.");
        console.log(pc, " ids processed in total.");
        i = 0;
        for (key in totalMap) {
            i++;
        }
        console.log('totalMap has ', i, ' items.');
    }
</script>
</html>
